<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafePlus GOD MODE MAX++ Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple Syntax Highlighting for PowerShell */
        .code-comment { color: #6a9955; }
        .code-keyword { color: #569cd6; }
        .code-string { color: #ce9178; }
        .code-function { color: #dcdcaa; }
        .code-variable { color: #9cdcfe; }
        .code-type { color: #4ec9b0; }
        .code-operator { color: #d4d4d4; }
        .code-number { color: #b5cea8; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="container bg-gray-800 max-w-4xl w-full mx-auto border border-gray-700 rounded-xl shadow-2xl shadow-red-900/20 overflow-hidden">
        <header class="bg-gray-800/50 p-6 text-center border-b border-gray-700">
            <h1 class="text-3xl font-bold text-white">SafePlus GOD MODE <span class="text-red-500">MAX++</span></h1>
            <p class="text-gray-400 mt-2">Optimización Extrema, Inteligente y Segura para Windows 10/11</p>
        </header>
        <main class="p-6">
            <div class="bg-yellow-900/30 border-l-4 border-yellow-400 text-yellow-200 p-4 mb-6 rounded-r-lg">
                <strong class="font-semibold">¡Atención!</strong> Este script realiza cambios profundos en el sistema. Úsalo bajo tu propio riesgo. Se recomienda crear un punto de restauración antes de ejecutarlo.
            </div>

            <div class="text-center mb-6">
                <button id="copyButton" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-500/50 transition-all duration-300 ease-in-out transform hover:-translate-y-1">
                    Copiar Script a Portapapeles
                </button>
            </div>

            <div class="bg-gray-900/70 p-4 rounded-lg overflow-x-auto max-h-[60vh] border border-gray-700">
                <pre><code id="scriptContent" class="text-sm whitespace-pre">&lt;#
.SYNOPSIS
  Windows 10/11 Optimizer – SafePlus GOD MODE MAX++
.DESCRIPTION
  Versión mejorada y robustecida del optimizador SafePlus, diseñada para un rendimiento máximo con seguridad y control.
  - MANEJO DE ERRORES AVANZADO: Detecta y reporta fallos sin detenerse abruptamente.
  - LIMPIEZA EXTREMA Y SEGURA: Elimina archivos innecesarios, cachés obsoletas y componentes redundantes de forma inteligente.
  - DEBLOAT INTELIGENTE: Desinstala bloatware preinstalado de forma limpia y completa.
  - OPTIMIZACIÓN PROFUNDA: Ajustes de CPU, RAM, red y disco para exprimir cada gota de rendimiento.
  - PRIVACIDAD TOTAL: Bloquea telemetría a nivel de servicios, registro y red (archivo hosts).
  - SEGURIDAD REFORZADA: Deshabilita protocolos y características vulnerables.
  - MANTENIMIENTO PROACTIVO: Optimiza unidades (SSD/HDD), gestiona la energía y actualiza el sistema completo (Windows, Drivers, Apps).
  - LOG DETALLADO: Crea un archivo de registro en C:\SafePlusOptimizer.log para auditoría.
.EXAMPLE
  .\SafePlusOptimizer.ps1 -RemoveBloatware -EnablePerformanceTweaks -HardenPrivacy -HardenSecurity -EnableUltimatePowerPlan -Confirm
.NOTES
  Autor: Gemini (basado en el script original)
  Versión: 2.0
#&gt;
[CmdletBinding(SupportsShouldProcess = $true)]
param(
  [switch]$RemoveBloatware = $true,
  [switch]$SkipIntegrity,
  [switch]$NoUpdate,
  [switch]$AggressiveCleanup,
  [switch]$EnablePerformanceTweaks = $true,
  [switch]$EnableUltimatePowerPlan = $true,
  [switch]$HardenPrivacy = $true,
  [switch]$HardenSecurity = $true,
  [switch]$EnableProactiveMaintenance,
  [switch]$OptimizeContextMenu,
  [switch]$Confirm
)

#========================
# ENTORNO DE EJECUCIÓN INICIAL
#========================
Clear-Host
$startTime = Get-Date
$logFile = "C:\SafePlusOptimizer.log"
Start-Transcript -Path $logFile -Force

function Write-Log { 
  param(
    [string]$Message, 
    [ValidateSet('INFO','WARN','ERROR','SUCCESS','TITLE','STEP')]$Level='INFO'
  )
  $ts = Get-Date -Format "HH:mm:ss"
  $color = @{INFO='White';WARN='Yellow';ERROR='Red';SUCCESS='Green';TITLE='Magenta';STEP='Cyan'}[$Level]
  $logEntry = "[{0}] [{1}] - {2}" -f $ts, $Level, $Message
  Write-Host $logEntry -ForegroundColor $color
}

#========================
# CONFIGURACIÓN CENTRALIZADA
#========================
$Global:Counters = @{
    ServicesDisabled = 0
    TasksDisabled = 0
    BloatwareRemoved = 0
    FeaturesDisabled = 0
    TelemetryHostsBlocked = 0
}

$BloatwareToRemove = @(
  "*Microsoft.Bing*","*Microsoft.Get*","*Microsoft.Messaging*","*Microsoft.MicrosoftSolitaireCollection*", 
  "*Microsoft.People*","*Microsoft.Print3D*","*Microsoft.ScreenSketch*","*Microsoft.WindowsAlarms*", 
  "*Microsoft.WindowsCamera*","*Microsoft.WindowsFeedbackHub*","*Microsoft.WindowsMaps*", 
  "*Microsoft.YourPhone*","*Microsoft.Zune*","*Microsoft.Xbox*","*king.com*", 
  "*Microsoft.549981C3F5F10*","*Microsoft.PowerAutomateDesktop*","*Microsoft.Windows.Clipchamp*", 
  "*Microsoft.Todos*","*Microsoft.Windows.Photos*","*MicrosoftTeams*","*Microsoft.Windows.WebExperience*",
  "*Microsoft.WindowsSoundRecorder*","*Microsoft.WindowsCalculator*","*Microsoft.WindowsStore*",
  "*Microsoft.WindowsNotepad*","*Microsoft.WindowsTerminal*","*Microsoft.MicrosoftEdge*",
  "*Microsoft.Windows.SecHealthUI*","*Microsoft.Windows.Cortana*","*Microsoft.Windows.ParentalControls*",
  "*Microsoft.Office.Sway*", "*SpotifyAB.SpotifyMusic*", "*Drawboard.DrawboardPDF*", "*ActiproSoftwareLLC.CodeWriter*"
)

$ServicesToDisable = @(
  'DiagTrack','dmwappushservice','RemoteRegistry','Fax','PhoneSvc','SysMain','wuauserv','BITS',
  'WerSvc','PcaSvc','HomeGroupListener','HomeGroupProvider','WSearch','WMPNetworkSvc',
  'XblAuthManager','XblGameSave','XboxNetApiSvc','bthserv','fhsvc','SSDPSRV','upnphost',
  'WbioSrvc','FrameServer','RetailDemo','VacSvc','WpnService','WpnUserService','spectrum',
  'MapsBroker','lfsvc','NetTcpPortSharing','WalletService'
) | Get-Unique

$TasksToDisable = @(
  '\Microsoft\Windows\Customer Experience Improvement Program\*', 
  '\Microsoft\Windows\Application Experience\*',
  '\Microsoft\Windows\DiskDiagnostic\*', 
  '\Microsoft\Windows\RetailDemo\*', 
  '\Microsoft\Office\Office Telemetry Agent*',
  '\Microsoft\Windows\Autochk\Proxy',
  '\Microsoft\Windows\Diagnosis\*',
  '\Microsoft\Windows\Feedback\*',
  '\Microsoft\Windows\Maintenance\WinSAT',
  '\Microsoft\Windows\NetTrace\GatherNetworkInfo',
  '\Microsoft\Windows\PI\Sqm-Tasks',
  '\Microsoft\Windows\Power Efficiency Diagnostics\AnalyzeSystem',
  '\Microsoft\Windows\Windows Error Reporting\QueueReporting',
  '\Microsoft\Windows\Shell\FamilySafetyUpload',
  '\Microsoft\Windows\WindowsUpdate\Automatic App Update'
)

$FeaturesToDisable = @(
  'WindowsMediaPlayer','MediaPlayback','WorkFolders-Client','Xps-Foundation-Xps-Viewer',
  'Printing-XPSServices-Features','FaxServicesClientPackage','Internet-Explorer-Optional-amd64',
  'MicrosoftWindowsPowerShellV2','MicrosoftWindowsPowerShellV2Root','SMB1Protocol'
)

#========================
# FUNCIONES PRINCIPALES
#========================
function Invoke-PreflightChecks {
    Write-Log "MÓDULO: Verificaciones Previas" 'TITLE'

    if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Log "Este script debe ejecutarse como Administrador. Saliendo." 'ERROR'
        Exit 1
    }

    if ($PSVersionTable.PSVersion.Major -lt 5) {
        Write-Log "Se requiere PowerShell 5 o superior. Saliendo." 'ERROR'
        Exit 1
    }
    
    if ($Confirm) {
        $confirmation = Read-Host "[?] Estás a punto de realizar cambios significativos en el sistema. ¿Deseas continuar? (S/N)"
        if ($confirmation -ne 'S') {
            Write-Log "Operación cancelada por el usuario. Saliendo." 'WARN'
            Exit 0
        }
    }
    Write-Log "Verificaciones superadas." 'SUCCESS'
}

function Invoke-SystemDiagnostics {
  Write-Log "MÓDULO: Diagnóstico y Respaldo" 'TITLE'
  $os = Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object Caption, Version
  Write-Log "SO: $($os.Caption) (Versión $($os.Version))" 'INFO'
  
  Write-Log "Creando Punto de Restauración del Sistema..." 'STEP'
  try {
    $restorePoint = Checkpoint-Computer -Description "Previo a SafePlus GOD MODE MAX++" -ErrorAction Stop
    Write-Log "Punto de restauración creado exitosamente." 'SUCCESS'
  } catch {
    Write-Log "No se pudo crear el punto de restauración. Verifica que la protección del sistema esté activada para C:." 'WARN'
  }
}

function Invoke-DeepClean {
    Write-Log "MÓDULO: Limpieza Profunda del Sistema" 'TITLE'
    $initialSpace = (Get-CimInstance -ClassName Win32_LogicalDisk -Filter "DeviceID='C:'").FreeSpace
    
    $paths = @(
        "$env:SystemRoot\Temp\*", "$env:TEMP\*", "$env:SystemRoot\SoftwareDistribution\Download\*",
        "$env:ProgramData\Microsoft\Windows\WER\*", "$env:SystemRoot\Prefetch\*.pf", "$env:LOCALAPPDATA\NVIDIA\GLCache\*",
        "$env:SystemRoot\Minidump\*.dmp", "$env:LOCALAPPDATA\CrashDumps\*", "$env:SystemRoot\Logs\CBS\*",
        "$env:APPDATA\Microsoft\Windows\Recent\*", "$env:LOCALAPPDATA\Microsoft\Windows\Explorer\thumbcache_*.db"
    )
    
    Get-ChildItem 'C:\Users' -Directory | Where-Object {$_.Name -notin @('Default','Public','All Users')} | ForEach-Object {
        $paths += "$($_.FullName)\AppData\Local\Temp\*"
    }
    
    $paths | ForEach-Object { Remove-Item $_ -Recurse -Force -ErrorAction SilentlyContinue }
    
    Clear-RecycleBin -Force -ErrorAction SilentlyContinue
    ipconfig /flushdns | Out-Null
    
    $finalSpace = (Get-CimInstance -ClassName Win32_LogicalDisk -Filter "DeviceID='C:'").FreeSpace
    $cleanedSpace = [math]::Round(($finalSpace - $initialSpace) / 1GB, 2)
    Write-Log "Limpieza profunda completada. Espacio liberado: $cleanedSpace GB." 'SUCCESS'
}

function Invoke-AggressiveClean {
  if (!$AggressiveCleanup) { return }
  Write-Log "MÓDULO: Limpieza Agresiva (Componentes y Cachés)" 'TITLE'
  
  Write-Log "Eliminando instantáneas de volumen (Shadow Copies)..." 'STEP'
  try { vssadmin delete shadows /all /quiet | Out-Null } catch {}
  
  Write-Log "Limpiando cola de impresión..." 'STEP'
  try {
    Stop-Service -Name Spooler -Force -ErrorAction Stop
    Remove-Item "$env:SystemRoot\System32\spool\PRINTERS\*" -Recurse -Force -ErrorAction SilentlyContinue
  } catch {
    Write-Log "No se pudo detener el servicio Spooler." 'WARN'
  } finally {
    Start-Service -Name Spooler -ErrorAction SilentlyContinue
  }

  Write-Log "Ejecutando limpieza de componentes de Windows (DISM)..." 'STEP'
  try {
    $dismParams = @{
        Online = $true
        CleanupImage = $true
        StartComponentCleanup = $true
        ResetBase = $true
        ErrorAction = 'Stop'
    }
    Repair-WindowsImage @dismParams | Out-Null
    Write-Log "Limpieza de componentes de DISM completada." 'SUCCESS'
  } catch {
    Write-Log "Falló la limpieza de componentes con DISM." 'ERROR'
  }
}

function Invoke-Debloat {
  if (!$RemoveBloatware) { return }
  Write-Log "MÓDULO: Eliminación de Bloatware" 'TITLE'
  
  foreach ($app in $BloatwareToRemove) {
    try {
        $packages = Get-AppxPackage -Name $app -AllUsers -ErrorAction SilentlyContinue
        if ($packages) {
            $packages | Remove-AppxPackage -AllUsers -ErrorAction Stop
            Write-Log "Eliminada App: $app" 'STEP'
            $Global:Counters.BloatwareRemoved++
        }

        $provisioned = Get-AppxProvisionedPackage -Online | Where-Object { $_.DisplayName -like $app }
        if ($provisioned) {
            $provisioned | Remove-AppxProvisionedPackage -Online -ErrorAction Stop
            Write-Log "Eliminado paquete provisionado: $($provisioned.DisplayName)" 'STEP'
        }
    } catch {
        Write-Log "No se pudo eliminar completamente '$app'." 'WARN'
    }
  }
  Write-Log "Eliminación de bloatware completada." 'SUCCESS'
}

function Invoke-SystemTuning {
  Write-Log "MÓDULO: Ajuste Fino del Sistema y UI" 'TITLE'
  
  Write-Log "Deshabilitando servicios innecesarios..." 'STEP'
  $ServicesToDisable.ForEach({
      $service = Get-Service $_ -ErrorAction SilentlyContinue
      if ($service -and $service.StartType -ne 'Disabled') {
          Set-Service -Name $_ -StartupType Disabled -ErrorAction SilentlyContinue
          Stop-Service -Name $_ -Force -ErrorAction SilentlyContinue
          $Global:Counters.ServicesDisabled++
      }
  })

  Write-Log "Deshabilitando tareas programadas innecesarias..." 'STEP'
  $TasksToDisable.ForEach({
      try {
          Get-ScheduledTask -TaskPath $_ -ErrorAction SilentlyContinue | Disable-ScheduledTask -ErrorAction Stop
          $Global:Counters.TasksDisabled++
      } catch {}
  })

  if ($EnablePerformanceTweaks) {
    Write-Log "Aplicando ajustes de rendimiento de Registro..." 'STEP'
    # UI: Rendimiento máximo, deshabilita efectos visuales
    Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" "VisualFXSetting" 3 -Force
    # UI: Sin retraso de inicio en apps
    Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Serialize" "StartupDelayInMSec" 0 -Force
    # CPU: Prioridad a aplicaciones en primer plano
    Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl" "Win32PrioritySeparation" 26 -Type DWord -Force
    # Memoria: No limpiar PageFile al apagar, mantener kernel en RAM
    Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" "ClearPageFileAtShutdown" 0 -Type DWord -Force
    Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" "DisablePagingExecutive" 1 -Type DWord -Force
    # NTFS: Deshabilitar actualización de último acceso y nombres 8.3
    fsutil behavior set disablelastaccess 1 | Out-Null
    fsutil behavior set disable8dot3 1 | Out-Null
    # Arranque: Deshabilitar DynamicTick y Hyper-V (para gaming)
    bcdedit /set disabledynamictick yes | Out-Null
    bcdedit /set useplatformclock true | Out-Null
    bcdedit /set hypervisorlaunchtype off | Out-Null
  }
  
  if ($OptimizeContextMenu) {
    Write-Log "Restaurando menú contextual clásico de Windows 10..." 'STEP'
    $keyPath = "HKCU:\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32"
    if (-not (Test-Path $keyPath)) { New-Item $keyPath -Force | Out-Null }
    Set-ItemProperty -Path $keyPath -Name "(Default)" -Value "" -Force
  }

  Write-Log "Ajuste de Sistema completado." 'SUCCESS'
}

function Invoke-PrivacyAndSecurity {
    if (!$HardenPrivacy -and !$HardenSecurity) { return }
    Write-Log "MÓDULO: Blindaje de Privacidad y Seguridad" 'TITLE'
    
    if ($HardenPrivacy) { 
        Write-Log "Aplicando ajustes de privacidad (Anti-Telemetría)..." 'STEP'
        # Deshabilitar telemetría
        Set-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" "AllowTelemetry" 0 -Type DWord -Force
        # Deshabilitar ID de publicidad
        Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\AdvertisingInfo" "Enabled" 0 -Type DWord -Force
        # Bloquear dominios de telemetría en archivo hosts
        $hostsFile = "$env:SystemRoot\System32\drivers\etc\hosts"
        $telemetryDomains = @(
            '0.0.0.0 telecommand.telemetry.microsoft.com', '0.0.0.0 telecommand.telemetry.microsoft.com.nsatc.net',
            '0.0.0.0 oca.telemetry.microsoft.com', '0.0.0.0 oca.telemetry.microsoft.com.nsatc.net',
            '0.0.0.0 ceuswatcab01.blob.core.windows.net', '0.0.0.0 ceuswatcab02.blob.core.windows.net',
            '0.0.0.0 df.telemetry.microsoft.com', '0.0.0.0 reports.wes.df.telemetry.microsoft.com',
            '0.0.0.0 vortex.data.microsoft.com', '0.0.0.0 vortex-win.data.microsoft.com',
            '0.0.0.0 watson.telemetry.microsoft.com', '0.0.0.0 watson.telemetry.microsoft.com.nsatc.net'
        )
        $currentHosts = Get-Content $hostsFile
        foreach ($domain in $telemetryDomains) {
            if ($currentHosts -notcontains $domain) {
                Add-Content -Path $hostsFile -Value $domain
                $Global:Counters.TelemetryHostsBlocked++
            }
        }
    }
    
    if ($HardenSecurity) {
        Write-Log "Aplicando ajustes de seguridad..." 'STEP'
        # Deshabilitar características vulnerables
        $FeaturesToDisable.ForEach({
            try {
                Disable-WindowsOptionalFeature -Online -FeatureName $_ -NoRestart -ErrorAction Stop | Out-Null
                $Global:Counters.FeaturesDisabled++
            } catch {}
        })
        # Configuración de Windows Defender
        Set-MpPreference -PUAProtection Enable -ErrorAction SilentlyContinue
        # Deshabilitar protocolos inseguros
        $tlsPath = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols"
        Set-ItemProperty "$tlsPath\SSL 3.0\Client" "Enabled" 0 -Type DWord -Force
        Set-ItemProperty "$tlsPath\SSL 3.0\Server" "Enabled" 0 -Type DWord -Force
        Set-ItemProperty "$tlsPath\TLS 1.0\Client" "Enabled" 0 -Type DWord -Force
        Set-ItemProperty "$tlsPath\TLS 1.0\Server" "Enabled" 0 -Type DWord -Force
        # Forzar UAC
        Set-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" "EnableLUA" 1 -Type DWord -Force
    }
    
    Write-Log "Blindaje completado." 'SUCCESS'
}

function Invoke-DriveMaintenance {
  if ($NoUpdate) { return }
  Write-Log "MÓDULO: Mantenimiento de Discos y Energía" 'TITLE'
  
  Write-Log "Deshabilitando hibernación..." 'STEP'
  powercfg /h off | Out-Null
  
  Write-Log "Optimizando unidades lógicas..." 'STEP'
  Get-CimInstance -ClassName Win32_LogicalDisk -Filter "DriveType=3" | ForEach-Object {
      $driveLetter = $_.DeviceID
      $volume = Get-Volume -DriveLetter ($driveLetter -replace ':')
      $physicalDisk = $volume | Get-Partition | Get-PhysicalDisk
      
      if ($physicalDisk.MediaType -eq 4) { # SSD
          Write-Log "Optimizando (TRIM) unidad SSD $driveLetter" 'STEP'
          Optimize-Volume -DriveLetter ($driveLetter -replace ':') -ReTrim -Verbose
      } elseif ($physicalDisk.MediaType -eq 3) { # HDD
          Write-Log "Desfragmentando unidad HDD $driveLetter" 'STEP'
          Optimize-Volume -DriveLetter ($driveLetter -replace ':') -Defrag -Verbose
      }
  }

  if ($EnableProactiveMaintenance) { 
    Write-Log "Activando Storage Sense (Sensor de Almacenamiento)..." 'STEP'
    Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\StorageSense\Parameters\StoragePolicy" "01" 1 -Type DWord -Force
  }
  
  if ($EnableUltimatePowerPlan) { 
    Write-Log "Activando Plan de Energía de Máximo Rendimiento..." 'STEP'
    $guid = "e9a42b02-d5df-448d-aa00-03f14749eb61"
    if (-not (powercfg /l | Select-String -Pattern $guid -Quiet)) { 
        powercfg -duplicatescheme 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c | Out-Null
    }
    powercfg /s $guid
    Write-Log "Plan de Máximo Rendimiento activado." 'SUCCESS'
  }
}

function Invoke-SystemUpdates {
  if ($NoUpdate) { return }
  Write-Log "MÓDULO: Actualización Total del Sistema" 'TITLE'
  
  Write-Log "Instalando módulo PSWindowsUpdate si es necesario..." 'STEP'
  if (-not (Get-Module -ListAvailable -Name PSWindowsUpdate)) {
      try {
          Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Confirm:$false
          Install-Module -Name PSWindowsUpdate -Force -SkipPublisherCheck -Scope AllUsers -Confirm:$false
      } catch {
          Write-Log "No se pudo instalar PSWindowsUpdate. Omitiendo actualizaciones de Windows/Drivers." 'ERROR'
          return
      }
  }
  
  Import-Module PSWindowsUpdate -Force
  Write-Log "Buscando e instalando actualizaciones de Windows y Drivers..." 'STEP'
  Get-WindowsUpdate -AcceptAll -Install -Verbose
  
  if (Get-Command winget -ErrorAction SilentlyContinue) {
      Write-Log "Actualizando aplicaciones con Winget..." 'STEP'
      winget upgrade --all --accept-source-agreements --accept-package-agreements --disable-interactivity
  } elseif (Get-Command choco -ErrorAction SilentlyContinue) {
      Write-Log "Actualizando aplicaciones con Chocolatey..." 'STEP'
      choco upgrade all -y --ignore-pinned
  } else {
      Write-Log "No se encontró Winget ni Chocolatey para actualizar aplicaciones." 'WARN'
  }
  
  Write-Log "Actualización del sistema completada." 'SUCCESS'
}

function Invoke-SystemIntegrityCheck {
    if ($SkipIntegrity) { return }
    Write-Log "MÓDULO: Verificación de Integridad del Sistema" 'TITLE'
    
    Write-Log "Ejecutando System File Checker (SFC)..." 'STEP'
    $sfcProcess = Start-Process sfc.exe -ArgumentList "/scannow" -Wait -NoNewWindow -PassThru
    if ($sfcProcess.ExitCode -ne 0) {
        Write-Log "SFC encontró problemas. Revisa el log CBS.log para detalles." 'WARN'
    } else {
        Write-Log "SFC completado sin problemas de integridad." 'SUCCESS'
    }
    
    Write-Log "Ejecutando DISM RestoreHealth..." 'STEP'
    $dismProcess = Start-Process dism.exe -ArgumentList "/Online /Cleanup-Image /RestoreHealth" -Wait -NoNewWindow -PassThru
    if ($dismProcess.ExitCode -ne 0) {
        Write-Log "DISM encontró problemas. Se recomienda una revisión manual." 'WARN'
    } else {
        Write-Log "DISM completado exitosamente." 'SUCCESS'
    }
}

function Invoke-PostRunSummary {
    $duration = (Get-Date) - $startTime
    Write-Log "================= RESUMEN DE LA OPTIMIZACIÓN =================" 'TITLE'
    Write-Log ("Duración Total: {0:N2} segundos" -f $duration.TotalSeconds) 'INFO'
    if ($Global:Counters.BloatwareRemoved -gt 0) { Write-Log "Apps de Bloatware eliminadas: $($Global:Counters.BloatwareRemoved)" 'SUCCESS' }
    if ($Global:Counters.ServicesDisabled -gt 0) { Write-Log "Servicios deshabilitados: $($Global:Counters.ServicesDisabled)" 'SUCCESS' }
    if ($Global:Counters.TasksDisabled -gt 0) { Write-Log "Tareas programadas deshabilitadas: $($Global:Counters.TasksDisabled)" 'SUCCESS' }
    if ($Global:Counters.FeaturesDisabled -gt 0) { Write-Log "Características de Windows deshabilitadas: $($Global:Counters.FeaturesDisabled)" 'SUCCESS' }
    if ($Global:Counters.TelemetryHostsBlocked -gt 0) { Write-Log "Dominios de telemetría bloqueados: $($Global:Counters.TelemetryHostsBlocked)" 'SUCCESS' }
    Write-Host "`nProceso completado. Se recomienda REINICIAR el equipo para aplicar todos los cambios." -ForegroundColor Green
    Write-Log "Log completo guardado en: $logFile" 'INFO'
    Write-Log "==============================================================" 'TITLE'
}

#========================
# EJECUCIÓN SECUENCIAL
#========================
try {
    Invoke-PreflightChecks
    Invoke-SystemDiagnostics
    Invoke-DeepClean
    Invoke-AggressiveClean
    Invoke-Debloat
    Invoke-SystemTuning
    Invoke-PrivacyAndSecurity
    Invoke-DriveMaintenance
    Invoke-SystemUpdates
    Invoke-SystemIntegrityCheck
} catch {
    Write-Log "Se ha producido un error fatal: $($_.Exception.Message)" 'ERROR'
} finally {
    Invoke-PostRunSummary
    Stop-Transcript
}
</code></pre>
            </div>
        </main>
    </div>

    <script>
        // Simple function to copy text to clipboard, avoiding potential iframe restrictions
        function copyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
            return success;
        }

        function applySyntaxHighlighting(codeElement) {
            let html = codeElement.innerHTML;
            
            // Comments
            html = html.replace(/(&lt;#!|#).*?(\n|&gt;)/g, (match) => `<span class="code-comment">${match}</span>`);
            // Keywords
            html = html.replace(/\b(function|param|if|else|foreach|try|catch|finally|switch|return|exit|while|param|CmdletBinding)\b/g, '<span class="code-keyword">$1</span>');
            // Types
            html = html.replace(/\[([a-zA-Z0-9_.]+)\]/g, '[<span class="code-type">$1</span>]');
            // Strings
            html = html.replace(/(['"])(.*?)\1/g, '<span class="code-string">$1$2$1</span>');
            // Functions/Cmdlets
            html = html.replace(/\b(Write-Host|Get-Date|Get-ChildItem|Remove-Item|Set-ItemProperty|New-Object|Get-Service|Stop-Service|Start-Service|Get-CimInstance|Set-ExecutionPolicy|Write-Log|Read-Host|Get-Module|Install-Module|Checkpoint-Computer|Clear-RecycleBin|Repair-WindowsImage|Get-AppxPackage|Remove-AppxPackage|Get-AppxProvisionedPackage|Remove-AppxProvisionedPackage|Get-ScheduledTask|Disable-ScheduledTask|Add-Content|Get-Content|Disable-WindowsOptionalFeature|Set-MpPreference|Get-Volume|Get-Partition|Get-PhysicalDisk|Optimize-Volume|Get-WindowsUpdate|Start-Process|Start-Transcript|Stop-Transcript)\b/g, '<span class="code-function">$1</span>');
            // Variables
            html = html.replace(/(\$[a-zA-Z0-9_:]+)/g, '<span class="code-variable">$1</span>');
            // Operators
            html = html.replace(/(-eq|-ne|-gt|-lt|-ge|-le|-like|-notlike|-match|-notmatch|-contains|-notcontains|-in|-notin|-replace)\b/g, '<span class="code-operator">$1</span>');
            // Numbers
            html = html.replace(/\b(\d+)\b/g, '<span class="code-number">$1</span>');

            codeElement.innerHTML = html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const copyButton = document.getElementById('copyButton');
            const scriptContentEl = document.getElementById('scriptContent');
            const scriptText = scriptContentEl.textContent; 

            applySyntaxHighlighting(scriptContentEl);

            copyButton.addEventListener('click', () => {
                if (copyTextToClipboard(scriptText)) {
                    copyButton.textContent = '¡Copiado!';
                    copyButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    copyButton.classList.add('bg-green-600');
                    setTimeout(() => {
                        copyButton.textContent = 'Copiar Script a Portapapeles';
                        copyButton.classList.remove('bg-green-600');
                        copyButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    }, 2000);
                } else {
                    copyButton.textContent = 'Error al copiar';
                }
            });
        });
    </script>

</body>
</html>
